from typing import List

import dlt
from dlt.extract.source import DltResource

from rest_api.typing import RESTAPIConfig
from rest_api import rest_api_source


@dlt.source(name="{{source_name}}", max_table_nesting=2)
def {{ source_name }}(
        {% if credentials %}
        {{ credentials.credentials_string }},
        {% endif %}
        base_url: str = dlt.config.value,
) -> List[DltResource]:

    # source configuration
    source_config: RESTAPIConfig = {
        "client": {
            "base_url": base_url,
            {% if credentials %}
            "auth": {{ credentials.auth_statement }},
            {% endif %}
        },
        "resources": 
        [
        {% for endpoint in endpoint_collection.all_endpoints_to_render %}
        {
            "name": "{{ endpoint.detected_resource_name }}",
            {% if endpoint.primary_key %}
            "primary_key": "{{ endpoint.primary_key }}",
            {% endif %}
            "endpoint": {
                "data_selector": "{{ endpoint.data_json_path }}",
                "path": "{{endpoint.path }}",
                {% if endpoint.transformer or endpoint.unresolvable_path_param_names or endpoint.unresolvable_query_param_names %}
                "params": {
                    {% if endpoint.transformer %}
                    {% for key, value in endpoint.transformer.path_params_mapping.items()%}
                    "{{key}}": {
                        "type": "resolve",
                        "resource": "{{endpoint.parent.detected_resource_name }}",
                        "field": "{{value}}",
                    },
                    {% endfor %}
                    {% endif %}
                    {% for param_name in endpoint.unresolvable_path_param_names %}
                    "{{param_name}}": "FILL_ME_IN", # TODO: fill in required path parameter
                    {% endfor %}
                    {% for param_name in endpoint.unresolvable_query_param_names %}
                    "{{param_name}}": "FILL_ME_IN", # TODO: fill in required query parameter
                    {% endfor %}
                },
                {% endif %}
                {% if endpoint.pagination_args %}
                "paginator": {
                    {% for key, value in endpoint.pagination_args.items() %}
                    "{{key}}":
                        {% if value is integer %}
                        {{value}},
                        {% else %}
                        "{{value}}",
                        {% endif %}
                    {% endfor %}
                },
                {% endif %}
            }
        },
        {% endfor %}
        ]
    }

    return rest_api_source(source_config)

